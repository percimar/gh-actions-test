# Creates a DRAFT GitHub Release when a tag like `release-2025-10-v1` is pushed.
# The release notes are auto-generated by GitHub.
# The release is created as a draft (not published) so you can review and publish manually.

name: Create Draft Release (auto notes)

on:
  push:
    tags:
      - "release-[0-9][0-9][0-9][0-9]-[0-9][0-9]-v*"

jobs:
  create-draft-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create draft release (Releases API)
        id: create_release
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "$TOKEN" ]; then
            echo "No token available in secrets.GITHUB_TOKEN" >&2
            exit 1
          fi

          echo "Creating draft release for tag '${{ github.ref_name }}'"

          API_URL="https://api.github.com/repos/${{ github.repository }}/releases"

          # Build JSON payload using jq for safe escaping
          PAYLOAD=$(jq -n \
            --arg tag "${{ github.ref_name }}" \
            --arg name "${{ github.ref_name }}" \
            '{tag_name: $tag, name: $name, draft: true, prerelease: false, generate_release_notes: true}')

          # POST and capture HTTP code and body
          HTTP_CODE=$(curl -s -o /tmp/release_response.json -w "%{http_code}" -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "$API_URL" -d "$PAYLOAD")

          echo "HTTP status: $HTTP_CODE"
          echo "Response body:" 
          cat /tmp/release_response.json || true

          if [ "$HTTP_CODE" -eq 201 ]; then
            ID=$(jq -r .id /tmp/release_response.json)
            HTML_URL=$(jq -r .html_url /tmp/release_response.json)
            UPLOAD_URL=$(jq -r .upload_url /tmp/release_response.json)
            echo "id=$ID" >> $GITHUB_OUTPUT
            echo "html_url=$HTML_URL" >> $GITHUB_OUTPUT
            echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT
            echo "Created draft release: $HTML_URL"
          else
            # Helpful diagnostics for common errors
            if [ "$HTTP_CODE" -eq 401 ] || [ "$HTTP_CODE" -eq 403 ]; then
              echo "ERROR: API returned $HTTP_CODE. This usually means the token lacks permissions." >&2
              echo "If you are using the default GITHUB_TOKEN, ensure repository Actions permissions allow 'Read and write' for the token." >&2
            fi
            echo "Full response:" >&2
            cat /tmp/release_response.json >&2 || true
            exit 1
          fi

      - name: Output release info
        run: |
          echo "Draft release created (if successful)."
          echo "Release id: ${{ steps.create_release.outputs.id }}"
          echo "HTML URL: ${{ steps.create_release.outputs.html_url }}"
          echo "Upload URL: ${{ steps.create_release.outputs.upload_url }}"
