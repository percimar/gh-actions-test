name: Demo - Deploy to Staging Environment

on:
  push:
    tags:
      - "staging-[0-9][0-9][0-9][0-9]-[0-9][0-9]-v*"

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract tag information
        run: |
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Update staging environment state in Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          # Create content file
          echo "// Staging Environment State" > env_state.txt
          echo "// Last deployed on: $(date)" >> env_state.txt
          echo "// From tag: ${{ env.TAG_NAME }}" >> env_state.txt
          echo "// Repository: ${{ github.repository }}" >> env_state.txt
          echo "" >> env_state.txt
          echo "Features currently in staging:" >> env_state.txt
          echo "--------------------------------" >> env_state.txt
          cat main.js >> env_state.txt

          # Function to create JSON payload
          create_payload() {
            jq -n \
              --arg desc "Staging Environment State for ${{ github.repository }}" \
              --arg content "$(cat env_state.txt)" \
              '{
                description: $desc,
                public: true,
                files: {
                  "staging_environment.txt": {
                    content: $content
                  }
                }
              }'
          }

          if [ -z "${{ vars.STAGING_GIST_ID }}" ]; then
            echo "Creating new Gist..."
            RESPONSE=$(curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.GIST_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              https://api.github.com/gists \
              -d "$(create_payload)")

            GIST_ID=$(echo "$RESPONSE" | jq -r '.id')
            if [ "$GIST_ID" = "null" ] || [ -z "$GIST_ID" ]; then
              echo "Error creating Gist. Response:"
              echo "$RESPONSE" | jq '.'
              exit 1
            fi
            echo "Successfully created Gist with ID: $GIST_ID"
            echo "STAGING_GIST_ID=$GIST_ID" >> $GITHUB_ENV
          else
            echo "Updating existing Gist..."
            curl -s -X PATCH \
              -H "Authorization: Bearer ${{ secrets.GIST_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              "https://api.github.com/gists/${{ vars.STAGING_GIST_ID }}" \
              -d "$(create_payload)"
          fi

      - name: Create deployment status
        run: |
          echo "ðŸš€ Demo deployment to staging complete"
          echo "Version: ${{ env.TAG_NAME }}"
          if [ -z "${{ vars.STAGING_GIST_ID }}" ]; then
            echo "First deployment: Check the action logs for the Gist ID"
          else
            echo "View staging environment state at: https://gist.github.com/${{ vars.STAGING_GIST_ID }}"
          fi
